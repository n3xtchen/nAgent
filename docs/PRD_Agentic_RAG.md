# Agentic RAG 产品设计文档 (PRD)

## 1. 产品背景与定位

### 1.1 背景
传统的 Simple RAG 系统主要依赖于“检索-增强-生成”的线性流程。虽然在处理简单查询时效果良好，但在面对复杂任务（如多步推理、含糊不清的查询、跨文档对比等）时，往往表现不佳。

### 1.2 定位
**Agentic RAG** 旨在通过引入“智能体 (Agent)”概念，将检索过程从被动的流程执行转变为主动的自主决策。它具备查询重写、多步检索、自反思以及工具化调用的能力，能够像人类专家一样处理复杂的信息检索和整合任务。

## 2. 核心功能定义

### 2.1 智能查询理解
- **查询重写 (Query Rewriting)**：将用户原始、可能含糊的自然语言查询改写为更适合搜索引擎或向量数据库检索的关键词或短语。
- **查询拆解 (Query Decomposition)**：将复杂的组合问题拆分为多个子问题，逐个解决后再进行汇总。

### 2.2 检索工具化 (Retrieval as a Tool)
- 将不同的检索源（如本地向量库、网络搜索、数据库查询）封装为 Agent 可调用的工具。
- Agent 根据当前任务的上下文，自主决定调用哪种工具以及调用的参数。

### 2.3 思考循环 (Reasoning Loop)
- **ReAct 模式**：遵循 "Reasoning + Acting" 循环，在每一步行动前先进行思考，执行后观察结果并调整后续策略。
- **多步推理**：能够根据前一步检索到的信息，动态生成下一步的检索请求，直至收集到足够的信息回答问题。

### 2.4 自反思与评估 (Self-Reflection)
- **结果验证**：在生成最终答案前，自我检查检索到的信息是否足以支撑回答，或检查生成的答案是否符合事实。
- **反馈闭环**：如果初次检索结果质量较差，Agent 能够自动触发重试逻辑或调整检索参数。

## 3. 系统架构

### 3.1 模块化设计
系统分为三个核心层次：
1.  **Agent Core**: 负责意图识别、决策调度和对话上下文管理。基于 `nagent-core` 构建。
2.  **RAG Tools**: 包含各种 Retriever（向量检索、关键词检索、混合检索等）。基于 `nagent-rag` 构建。
3.  **Application Layer**: `apps/agentic-rag` 作为最终的集成应用，提供 API 或 UI 接口。

### 3.2 接口规范
- 扩展 `BaseRetriever` 接口，使其支持更复杂的元数据过滤和参数化配置。
- 统一工具调用协议，确保 Agent 可以无缝切换不同的检索后端。

## 4. 演进路线图 (Roadmap)

### Phase 1: 基础构建 (Foundation)
- 实现基础的 Agent 循环框架。
- 集成现有的 `nagent-rag` 关键词匹配功能作为首个工具。
- 实现简单的查询改写逻辑。

### Phase 2: 推理增强 (Reasoning & Reflection)
- 引入 ReAct 思考模版。
- 实现查询拆解逻辑，支持跨文档的多点检索。
- 加入初步的自反思环节，评估检索内容的相关性。

### Phase 3: 性能优化与混合检索 (Optimization)
- 集成向量检索，并实现 Hybrid Search（向量 + 关键词）。
- 优化长上下文处理策略。
- 引入检索后的重排 (Rerank) 机制。

## 5. 评估与质量控制

### 5.1 衡量指标
- **答案准确率 (Answer Accuracy)**：针对基准测试集的回答准确程度。
- **检索相关性 (Retrieval Relevance)**：检索出的 Top-K 文档与问题的相关度。
- **推理步数 (Reasoning Steps)**：衡量 Agent 解决问题的效率，避免陷入无限循环。

### 5.2 评估工具
- 使用 RAGAS 或类似框架进行自动化评估。
- 建立人工反馈数据集，持续微调 Prompt 策略。
